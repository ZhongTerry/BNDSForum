{% extends "base.html" %}
{% import "_macros/assets.html" as assets with context %}
{% block title %}{{ '编辑文章' if post_id else '撰写文章' }} - BNDS Blog{% endblock %}
{% block extra_head %}
    {{ super() }}
    {{ assets.markdown_view_styles() }}
    {{ assets.markdown_editor_styles() }}
{% endblock %}
{% block extra_scripts %}
    {{ super() }}
    {{ assets.markdown_view_scripts() }}
    {{ assets.markdown_editor_scripts() }}
{% endblock %}
{% block content %}
<section class="card form-card">
    <script>
        window.addEventListener('beforeunload', function (e) {
// 设置提示信息
const confirmationMessage = '您确定要离开此页面吗？未保存的数据可能会丢失。';
e.preventDefault(); // 阻止默认行为
e.returnValue = confirmationMessage; // Gecko 和 IE 浏览器兼容
return confirmationMessage; // Webkit 浏览器兼容
});
        </script>
    <header class="form-header">
        <h1>{{ '编辑文章' if post_id else '撰写文章' }}</h1>
        <p class="form-tip">正文支持 Markdown 语法，可直接粘贴图片链接或代码片段。</p>
    </header>

    {% if error %}
        <div class="flash error inline">{{ error }}</div>
    {% endif %}

    <form method="post" class="form-grid">
        <div class="form-field">
            <label for="title">标题</label>
            <input type="text" id="title" name="title" value="{{ title }}" placeholder="输入文章标题" required>
        </div>

        <div class="form-field markdown-field">
            <label for="content">正文</label>
            <div class="markdown-editor" data-markdown-editor>
                <div class="markdown-toolbar" role="toolbar" aria-label="Markdown 工具栏">
                    <button type="button" class="markdown-tool" data-md-prefix="# " title="插入一级标题">#</button>
                    <button type="button" class="markdown-tool" data-md-surround="**" title="加粗">Bold</button>
                    <button type="button" class="markdown-tool" data-md-surround="*" title="斜体">Italic</button>
                    <button type="button" class="markdown-tool" data-md-surround="`" title="行内代码">Code</button>
                    <button type="button" class="markdown-tool" data-md-block="```" title="代码块">Code Block</button>
                    <button type="button" class="markdown-tool" data-md-prefix="- " title="无序列表">List</button>
                </div>
                <div class="markdown-panels">
                    <div class="markdown-panel markdown-panel-editor">
                        <textarea id="content"
                                  name="content"
                                  rows="14"
                                  placeholder="使用 Markdown 编写，例如：# 一级标题、**粗体**、```代码```"
                                  data-required-message="正文不能为空"
                                  data-markdown-source>{{ content }}</textarea>
                    </div>
                    <div class="markdown-panel markdown-panel-preview">
                        <div class="markdown-preview markdown-body" aria-live="polite"></div>
                    </div>
                </div>
            </div>
        </div>

        {% set constant_list = author_constant_tags if author_constant_tags is defined else current_user.constant_tags %}
        <div class="form-field">
            <label>自动附加标签</label>
            <div class="tag-collection">
                {% for tag in constant_list %}
                    <span class="tag-badge">{{ tag }}</span>
                {% else %}
                    <span class="tag-badge muted">暂无固定标签</span>
                {% endfor %}
            </div>
        </div>

        {% if extra_tags is defined and extra_tags %}
            <div class="form-field">
                <label>作者自定义标签</label>
                <div class="tag-collection">
                    {% for tag in extra_tags %}
                        <span class="tag-badge">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="form-field">
            <label for="normal_tags">选择常用标签</label>
            <select id="normal_tags" name="normal_tags" multiple size="8">
                {% for tag in available_tags %}
                    <option value="{{ tag }}" {% if tag in selected_tags %}selected{% endif %}>{{ tag }}</option>
                {% endfor %}
            </select>
            <p class="field-hint">按住 Ctrl 或 Command 键可多选标签。</p>
        </div>

        <div class="form-actions">
            <button type="submit" class="button primary">保存</button>
            <a class="button ghost" href="{{ url_for('blog.index') }}">返回列表</a>
        </div>
    </form>
</section>
{% endblock %}
